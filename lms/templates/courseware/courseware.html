<%page expression_filter="h"/>
<%inherit file="/main.html" />
<%namespace name='static' file='/static_content.html'/>
<%def name="online_help_token()"><% return "courseware" %></%def>
<%!
from django.utils.translation import ugettext as _
from django.conf import settings

from edxnotes.helpers import is_feature_enabled as is_edxnotes_enabled
from openedx.core.djangolib.markup import HTML
from openedx.core.djangolib.js_utils import js_escaped_string
%>
<%
  include_special_exams = settings.FEATURES.get('ENABLE_SPECIAL_EXAMS', False) and (course.enable_proctored_exams or course.enable_timed_exams)
%>
<%def name="course_name()">
 <% return _("{course_number} Courseware").format(course_number=course.display_number_with_default) %>
</%def>

<%block name="bodyclass">view-in-course view-courseware courseware ${course.css_class or ''}</%block>

<%block name="title"><title>
    % if section_title:
${static.get_page_title_breadcrumbs(section_title, course_name())}
    % else:
${static.get_page_title_breadcrumbs(course_name())}
    %endif
</title></%block>

<%block name="header_extras">
<link rel="stylesheet" type="text/css" href="${static.url('css/tma_courseware.css')}" />

% for template_name in ["image-modal"]:
<script type="text/template" id="${template_name}-tpl">
    <%static:include path="common/templates/${template_name}.underscore" />
</script>
% endfor

% if settings.FEATURES.get('ENABLE_COURSEWARE_SEARCH'):
    % for template_name in ["course_search_item", "course_search_results", "search_loading", "search_error"]:
        <script type="text/template" id="${template_name}-tpl">
            <%static:include path="search/${template_name}.underscore" />
        </script>
    % endfor
% endif

% if include_special_exams:
  % for template_name in ["proctored-exam-status"]:
    <script type="text/template" id="${template_name}-tpl">
        <%static:include path="courseware/${template_name}.underscore" />
    </script>
  % endfor
% endif

</%block>

<%block name="headextra">
<%static:css group='style-course-vendor'/>
<%static:css group='style-course'/>
## Utility: Notes
% if is_edxnotes_enabled(course):
<%static:css group='style-student-notes'/>
% endif

<%include file="../discussion/_js_head_dependencies.html" />
  ${HTML(fragment.head_html())}
</%block>

<%block name="js_extra">
  <script type="text/javascript" src="${static.url('common/js/vendor/jquery.scrollTo.js')}"></script>
  <script type="text/javascript" src="${static.url('js/vendor/flot/jquery.flot.js')}"></script>

  ## codemirror
  <script type="text/javascript" src="${static.url('js/vendor/codemirror-compressed.js')}"></script>

  <%static:js group='courseware'/>
  <%static:js group='discussion'/>
  % if settings.FEATURES.get('ENABLE_COURSEWARE_SEARCH'):
    <%static:require_module module_name="js/search/course/course_search_factory" class_name="CourseSearchFactory">
        var courseId = $('.courseware-results').data('courseId');
        CourseSearchFactory(courseId);
    </%static:require_module>
  % endif

  <%static:require_module module_name="js/courseware/courseware_factory" class_name="CoursewareFactory">
    CoursewareFactory();
  </%static:require_module>

  <%include file="../discussion/_js_body_dependencies.html" />
  % if staff_access:
    <%include file="xqa_interface.html"/>
  % endif

  <script type="text/javascript">
    var $$course_id = "${course.id | n, js_escaped_string}";
  </script>

${HTML(fragment.foot_html())}

</%block>

<div class="message-banner" aria-live="polite"></div>

% if default_tab:
  <%include file="/courseware/course_navigation.html" />
% else:
  <%include file="/courseware/course_navigation.html" args="active_page='courseware'" />
% endif

<div class="container">
  <div class="button-phone-menu">
    <button id="active_menu"><span class="icon fa fa-caret-right" aria-hidden="true"></span>${_(' course content')}</button>
  </div>
  <div class="course-wrapper" role="presentation">

% if disable_accordion is UNDEFINED or not disable_accordion:
    <div class="course-index">
      <div class="wrapper-course-modes">

          <div class="courseware-bookmarks-button" data-bookmarks-api-url="${bookmarks_api_url}">
              <button type="button" class="bookmarks-list-button is-inactive" aria-pressed="false">
                  ${_('Bookmarks')}
              </button>
          </div>

          % if settings.FEATURES.get('ENABLE_COURSEWARE_SEARCH'):
            <div id="courseware-search-bar" class="search-bar courseware-search-bar" role="search" aria-label="Course">
              <form>
                <label for="course-search-input" class="sr">${_('Course Search')}</label>
                <div class="search-field-wrapper">
                  <input id="course-search-input" type="text" class="search-field"/>
                  <button type="submit" class="search-button">
                    ${_('search')} <span class="icon fa fa-search" aria-hidden="true"></span>
                  </button>
                  <button type="button" class="cancel-button" title="${_('Clear search')}">
                    <span class="icon fa fa-remove" aria-hidden="true"></span>
                  </button>
                </div>
              </form>
            </div>
          % endif

      </div>

      <div class="accordion">
        <nav class="course-navigation" aria-label="${_('Course')}">
          % if accordion.strip():
            ${HTML(accordion)}
          % else:
            <div class="chapter">${_("No content has been added to this course")}</div>
          % endif
        </nav>
      </div>

    </div>
% endif
    <section class="course-content" id="course-content">
        <main id="main" aria-label="Content" tabindex="-1">
        % if getattr(course, 'entrance_exam_enabled') and \
           getattr(course, 'entrance_exam_minimum_score_pct') and \
           entrance_exam_current_score is not UNDEFINED:
            % if not entrance_exam_passed:
            <p class="sequential-status-message">
                ${_('To access course materials, you must score {required_score}% or higher on this \
                exam. Your current score is {current_score}%.').format(
                    required_score=int(round(course.entrance_exam_minimum_score_pct * 100)),
                    current_score=int(round(entrance_exam_current_score * 100))
                )}
            </p>
            <script type="text/javascript">
            $(document).ajaxSuccess(function(event, xhr, settings) {
                if (settings.url.indexOf("xmodule_handler/problem_check") > -1) {
                    var data = JSON.parse(xhr.responseText);
                    if (data.entrance_exam_passed){
                        location.reload();
                    }
                }
            });
            </script>
            % else:
              <p class="sequential-status-message">
                ${_('Your score is {current_score}%. You have passed the entrance exam.').format(
                    current_score=int(round(entrance_exam_current_score * 100))
                )}
            </p>
            % endif
        % endif

          ${HTML(fragment.body_html())}
          <a id="floating_button" class="fail" style="display:none">
            <i class="fa fa-comments-o"></i>
          </a>
        </main>
    </section>

    <section class="courseware-results-wrapper">
      <div id="loading-message" aria-live="polite" aria-relevant="all"></div>
      <div id="error-message" aria-live="polite"></div>
      <div class="courseware-results search-results" data-course-id="${course.id}" data-lang-code="${language_preference}"></div>
    </section>

  </div>
</div>
<div class="container-footer">
  % if settings.FEATURES.get("LICENSING", False):
    <div class="course-license">
    % if getattr(course, "license", None):
      <%include file="../license.html" args="license=course.license" />
    % else:
      ## Default course license: All Rights Reserved, if none is explicitly set.
      <%include file="../license.html" args="license='all-rights-reserved'" />
    % endif
    </div>
  % endif
</div>

<nav class="nav-utilities ${"has-utility-calculator" if course.show_calculator else ""}" aria-label="${_('Course Utilities')}">
  ## Utility: Notes
  % if is_edxnotes_enabled(course):
    <%include file="/edxnotes/toggle_notes.html" args="course=course"/>
  % endif

  ## Utility: Calc
  % if course.show_calculator:
    <%include file="/calculator/toggle_calculator.html" />
  % endif
</nav>

<%include file="../modal/accessible_confirm.html" />
<script type="text/javascript">
  mPrepareTrackAjax = function(){
    var mUsageIds = [];
    var mCourseId = "${course.id}";

    $(".vert .xblock-student_view-html").each(function(){
      mUsageIds.push($(this).attr('data-usage-id'));
    });

    if(mUsageIds.length > 0){

      $.post({
        url: "/track_html_component/",
        data: {
          'usage_ids': JSON.stringify(mUsageIds),
          'course_id': mCourseId
        }
      }); // post

    } // if
  }

  getCompletionStatus = function(){
    var mCourseId = "${course.id}";
    var circleGreen = '<div class="completed green"></div>';
    var circleGray = '<div class="completed gray"></div>';

    $.get({
      url: "/completion_status/",
      data: {
        'course_id': mCourseId
      },
      success: function(data) {
        var chaptersCompleted = data['completion_status']['chapters_completed'];
        for (var chapterIndex in chaptersCompleted) {
          var chapterName = chaptersCompleted[chapterIndex];
          chapterName = chapterName.replace(/:/g, "");
          chapterName = chapterName.replace(/  /, " ");
          var ChapterID = "#" + (chapterName.split(" ").join("-").toLowerCase() + "-parent");
          $(ChapterID).children().find(".completed").remove();
          $(ChapterID).children().append(circleGreen);
          var childrenSectionsId = ChapterID.replace("parent", "child");
          $(childrenSectionsId).children().children().each(function(){
            $(this).children().children().find(".completed").remove();
            $(this).children().children(".accordion-display-name").append(circleGreen);
          });
        } // for 1

        var sectionsCompleted = data['completion_status']['sections_completed']
        for (var sectionIndex in sectionsCompleted) {
          var sectionName = sectionsCompleted[sectionIndex];
          var parentChapter = $("a.accordion-nav[href*='"+sectionName+"']").parent().parent().parent().prev();
          parentChapter.children().find(".completed").remove();
          parentChapter.children().append(circleGray);
          $("a.accordion-nav[href*='"+sectionName+"']").children().find(".completed").remove();
          $("a.accordion-nav[href*='"+sectionName+"']").find(".accordion-display-name").append(circleGreen);
        } // for 2

      }
    }); // get

  }

floatingButton = function(){

    var floating_button = $('#floating_button')
    var discussion_block = $('*[data-block-type=discussion]')
    if (discussion_block.length > 0)
    {
    discussion_block_id = discussion_block.attr('data-usage-id');
    discussion_block.attr('id',discussion_block_id);
    floating_button.attr('href','#'+discussion_block_id);
    path = window.location.pathname;
    path_array = path.split("/");
    course_id = "${course.id}";
    section_id = path_array[5];
    $.get({

    url: "/pass_fail/"+course_id+"/"+section_id,
    dataType: "json",
    success: function(data) {
      var studentPassed = data['passed']
      if (studentPassed == true){
        floating_button.attr('class','pass');
        floating_button.css('display','block');
      }
      else{
       floating_button.css('display','block');
      }
    },
    failure: function(data) {
        console.log(data)
    }
    })
  }
  else{
    floating_button.css('display','none');
  }
}

// Add by chintan to get the tutor mark in the discussion
callForAllUser = function(){
    var course_id = "${course.id.to_deprecated_string()}";
    var discussion_block = $('*[data-block-type=discussion]')
    discussion_id = discussion_block.find($("div[class='discussion-module']")).attr('data-discussion-id')
    users = $('.username')
    user_list = []
    for (i=0; i< users.length; i++)
    {
        user_list.push(users[i].text)
    }
    unique_users_list = $.unique(user_list)

    $.get({

        url: "/tutor_tag/"+course_id+"/"+discussion_id,
        data: {'users':unique_users_list},
        success: function(data) {
            data = data['data']
            var tag = '<span class="user-label-staff tutor">TUTOR</span>'
            $(".tutor").remove();
            for (index=0; index < data.length; index++) {
                var passed = data[index]['passed'];
                if(passed == true){
                    var uName = data[index]['username'];
                    var authorTags = $(".username:contains('"+uName+"')");
                    authorTags.each(function(index){
                        if($(this).parent().parent().hasClass('discussion-comment')){
                            $(this).next('span.box').after(tag);
                        } else {
                            $(this).after(tag);
                        }
                    });
                }
            };

        },
        failure: function(data) {
            console.log(data)
        }
    })
}
// End of Tutor Mark

  $(document).ready(function(){
    mPrepareTrackAjax();
    % if settings.FEATURES.get('TMA_ENABLE_COMPLETION_TRACKING'):
      getCompletionStatus();
    % endif
    floatingButton();
  });
  $(document).ajaxSuccess(function(event, xhr, settings){
    if( settings.url.indexOf('goto_position')>=0 ) {
      mPrepareTrackAjax();
      floatingButton();
    } else {
      % if settings.FEATURES.get('TMA_ENABLE_COMPLETION_TRACKING'):
        var seen_video = settings.url.indexOf('save_user_state')>=0;
        var attended_problem = settings.url.indexOf('problem_check')>=0;
        var seen_hint = settings.url.indexOf('hint_button');
        var graded_lti_v2 = settings.url.indexOf('lti_2_0_result_rest_handler')>=0;
        var got_grade = settings.url.indexOf('grade_handler')>=0;
        var rendered_grade = settings.url.indexOf('render_grade')>=0;
        var seen_html = settings.url.indexOf('track_html_component')>=0;
        if (seen_video || attended_problem || seen_hint || graded_lti_v2 || got_grade || rendered_grade || seen_html) {
          getCompletionStatus();
          floatingButton();
        }
      % endif
    }
    % if settings.FEATURES.get('TMA_TUTOR_FLAG'):
      var resp_limit = settings.url.indexOf('resp_limit=25')>=0
      var reply = settings.url.indexOf('reply?ajax=1')>=0
      var inline = settings.url.indexOf('inline?page=1&ajax=1')>=0
      var create = settings.url.indexOf('create?ajax=1')>=0
      if ( resp_limit || reply || inline || create )
        {
            callForAllUser();
        }
    % endif

  });

</script>
<script>
function ActionSiUneSection() {
  var nombre = $('.menu-item').length;
  if(parseInt(nombre) <= 1) {
    $('.course-index').hide();
  }
}
function menuPhone() {
    $('#active_menu').click(function(){
            if($('.course-index').css('display') == 'none') {
              $('.course-index').show();
              console.log('putain de display de mes couilles');
            }else{
              $('.course-index').hide();
            }
    })
  }

function sizeMenu() {
    if((parseInt($(window).width()) > 768) && (parseInt($(window).width()) != 1024)) {
            $('.course-index').attr('style','');
      }
}
function customRadioLabel(){
  var Cible = $('fieldset').attr('role','radiogroup').children('label');
  Cible.css('background-color','#fff');
  Cible.css('margin-bottom','3px');
  Cible.each(function(){
  var LocateRadio = $(this).attr('for');
  console.log($('input[name="LocateRadio"]'));

  })
  Cible.click(function(){
    $(this).parent().children('label').css('background-color','#fff');
    $(this).parent().children('label').css('color','#000');
    $(this).parent().children('label').css('border-color','transparent');
    $(this).css('color','#fff');
    $(this).css('background-color','#A2C126');
    $(this).css('border-color','#A2C126');
  })
}
function clearMarginFooter(){
  var url = window.location.href;
  if(url.indexOf('/courseware/') != -1){
    $('.wrapper-footer').css('margin-top','0px');
  }
}
$('fieldset').ready(function(){
  customRadioLabel();
  $('.check').click(function(){
    customRadioLabel();
  })
})
/* ipad fix */
  function ipadCourse() {
    var width = parseInt($(window).width());
    var url = window.location.href;
    if((width == 1024) && (url.indexOf('/courseware/') != -1)) {
      $('.course-index').css('width','310px');
      $('#active_menu').css('width','310px');
      $('#course-content').css('width','714px');
      $('#active_menu').hide();
    }else{
      $('.course-index').attr('style','');
      $('#active_menu').attr('style','');
    }
  }
/* end ipad fix */
$(document).ready(function(){
  clearMarginFooter();
  menuPhone();
  ActionSiUneSection();
  ipadCourse();
})
$(window).resize(function(){
  sizeMenu();
  ipadCourse();
})
</script>
<style>
.path {
  display: none;
}
.xmodule_display.xmodule_SequenceModule .sequence-nav,.xmodule_display.xmodule_SequenceModule nav.sequence-bottom {
  display : none;
}
input[type="radio"] {
  display: none;
}
body.view-in-course .wrapper-footer {
  padding: 0;
}
.xmodule_display.xmodule_CapaModule div.problem .choicegroup label.choicegroup_correct, .xmodule_display.xmodule_CapaModule div.problem .choicetextgroup label.choicegroup_correct, .xmodule_display.xmodule_CapaModule div.problem .choicetextgroup label.choicetextgroup_correct, .xmodule_display.xmodule_CapaModule div.problem .choicetextgroup section.choicetextgroup_correct {
  border: 2px solid transparent;
}
.xmodule_display.xmodule_CapaModule div.problem .choicegroup label.choicegroup_incorrect:hover, .xmodule_display.xmodule_CapaModule div.problem .choicetextgroup label.choicegroup_incorrect:hover, .xmodule_display.xmodule_CapaModule div.problem .choicetextgroup label.choicetextgroup_incorrect:hover, .xmodule_display.xmodule_CapaModule div.problem .choicetextgroup section.choicetextgroup_incorrect:hover {
  border: 2px solid transparent;
}
.xmodule_display.xmodule_CapaModule div.problem .choicegroup label.choicegroup_incorrect, .xmodule_display.xmodule_CapaModule div.problem .choicetextgroup label.choicegroup_incorrect, .xmodule_display.xmodule_CapaModule div.problem .choicetextgroup label.choicetextgroup_incorrect, .xmodule_display.xmodule_CapaModule div.problem .choicetextgroup section.choicetextgroup_incorrect {
  border: 2px solid transparent;
}
.xmodule_display.xmodule_CapaModule div.problem .choicegroup label:hover, .xmodule_display.xmodule_CapaModule div.problem .choicetextgroup label:hover {
  border: 2px solid transparent;
}
.xmodule_display.xmodule_CapaModule div.problem .choicegroup label, .xmodule_display.xmodule_CapaModule div.problem .choicetextgroup label {
  border: 2px solid transparent;
}
.xmodule_display.xmodule_CapaModule div.problem .choicegroup label.choicegroup_correct:hover, .xmodule_display.xmodule_CapaModule div.problem .choicetextgroup label.choicegroup_correct:hover, .xmodule_display.xmodule_CapaModule div.problem .choicetextgroup label.choicetextgroup_correct:hover, .xmodule_display.xmodule_CapaModule div.problem .choicetextgroup section.choicetextgroup_correct:hover{
  border: 2px solid transparent;
}
.content, .course-wrapper .course-content, .course-wrapper .courseware-results-wrapper, div.info-wrapper section.updates, div.book-wrapper .book, .profile-wrapper .course-info, div.gradebook-wrapper section.gradebook-content, .view-student-notes .wrapper-student-notes .student-notes, .instructor-dashboard-content-2 {
  width: calc(68% - 50px);
  padding-right: 25px;
  padding-left: 25px;
  background-color: #F5F6F8;
}
.container>div {
  background-color: #F5F6F8;
}
body, h1, h2, h3, h4, h5, h6, p, label,.xmodule_display.xmodule_HtmlModule p {
  color: #363F4D;
  font-size: 16px;
  font-family: 'helveticaneue';
}
.action button,.action button:hover, .action button:focus {
  background-color: #fff;
  background-image: none;
  color: #8a4185;
  border: 2px solid #8a4185;
  box-shadow: none;
}
.xblock .xblock h3,.xmodule_display.xmodule_HtmlModule h2 {
  color: #8a4185;
  font-family: 'gothamrounded-bold';
}
.xmodule_display.xmodule_HtmlModule h2 {
  font-size: 30px;
}
.wrapper-course-material {
  width: 1440px;
  background-color: #F5F6F8;
}
body.view-in-course .wrapper-course-material .course-material .course-tabs {
  padding-top: 15px;
  padding-bottom: 15px;
}
.container>div {
  border: none;
  width: 1440px;
  margin-left: auto;
  margin-right: auto;
}
body.view-in-course .container {
  padding: 0;
}
.course-index {
  border: none;
  width: 32%;
}
.wrapper-course-modes {
  display: none;
}
.group-heading {
  padding: 0;
  background-color: #009DE0;
  color: #fff;
}
.course-index .accordion .course-navigation .button-chapter.active .group-heading {
  color: #fff;
  font-size: 18px;
  font-family: 'helveticaneue-medium';
  font-weight: normal;
}
.xmodule_display.xmodule_SequenceModule .sequence-nav-button:hover {
  width: 40px;
  height: 46px;
  box-shadow: none;
}

.course-index .accordion .course-navigation .chapter-content-container .chapter-menu .menu-item.active a p{
  height: 20px;
  line-height: 20px;
  vertical-align: middle;
}

.menu-item {
  padding-bottom: 0;
  padding-top: 15px;
  padding-bottom: 15px;
}
.xmodule_display.xmodule_SequenceModule .sequence-nav-button.button-next,.xmodule_display.xmodule_SequenceModule .sequence-nav-button.button-previous,#active_menu {
  border-radius: 0px;
  background-color: #009DE0;
  background-image: none;
  color: #fff;
}
#active_menu {
  width: calc(100%);
  height: 42px;
  padding: 0;
  padding-left: 15px;
  margin: 0;
  box-shadow: none;
  border: none;
  line-height: 42px;
  vertical-align: middle;
  text-align: left;
  font-size: 18px;
  font-family: 'helveticaneue-medium';
  font-weight: normal;
  text-shadow: none;
}
.xmodule_display.xmodule_SequenceModule .sequence-nav .sequence-list-wrapper {
  border: 1px solid #009DE0;
  background-color: #fff;
  background-image: none;
}
.xmodule_display.xmodule_SequenceModule .sequence-nav ol li {
  padding: 0;
  padding-top: 1px;
}
.xmodule_display.xmodule_SequenceModule .sequence-nav ol li button, {
  background-color: rgba(0,0,0,0.1);
}
.xmodule_display.xmodule_SequenceModule .sequence-nav ol {
  background-color: rgba(0,0,0,0.1);
}
.xmodule_display.xmodule_CapaModule div.problem p {
  font-size: 20px;
  font-weight: bold;
}
.button-phone-menu {
  display : none;
  width: 100vw;
  height: 30px;
}
#active_menu {
  display: none;
}
.completed {
 display: none;
}
@media(max-width:1440px) {
  .container>div {
    border: none;
    width: 100vw;
    margin-left: auto;
    margin-right: auto;
  }
  .wrapper-course-material {
    width: 100%;
  }
}
@media(max-width:768px) {
  .content, .course-wrapper .course-content, .course-wrapper .courseware-results-wrapper, div.info-wrapper section.updates, div.book-wrapper .book, .profile-wrapper .course-info, div.gradebook-wrapper section.gradebook-content, .view-student-notes .wrapper-student-notes .student-notes, .instructor-dashboard-content-2 {
    width: calc(100vw - 20px);
    padding: 10px;
    clear: left;
    display: block;
  }
  .button-phone-menu {
    display: block;
  }
  #active_menu {
    display: block;
  }
  .content, .course-wrapper .course-content, .course-wrapper .courseware-results-wrapper, div.info-wrapper section.updates, div.book-wrapper .book, .profile-wrapper .course-info, div.gradebook-wrapper section.gradebook-content, .view-student-notes .wrapper-student-notes .student-notes, .instructor-dashboard-content-2 {
    box-sizing: content-box;
  }

  .course-index {
    width: calc(100vw);
    margin: 0;
    clear: left;
    display: none;
  }
}
</style>
% if 'course-v1:Amundi+2016-0010+2016-0010-T4' in str(course.id) or 'course-v1:Amundi+2016-0011+2016-0011-T4' in str(course.id) or 'course-v1:Amundi+2018-005+2018-005-T2' in str(course.id):
<style>
.xmodule_display.xmodule_CapaModule div.problem .action .check {
  display: none;
}
.accordion,.course-index {
  display: none;
}
iframe {
  width: 100%;
  height: 730px;
}
</style>
<script>
    function checkCheck() {
      //$('button').hasClass('check').hide();
      var doc_colab = 'https://www.phileasamundi.com/scorm/edufactory_entretien_collab/index_lms_html5.html';
      var doc_manag = 'https://www.phileasamundi.com/scorm/edufactory_entretien_manager/index_lms_html5.html';
      var item = $('iframe').attr('src');
      var check = '';
      localStorage.setItem('resultat', 'false');   
      localStorage.setItem('score', 'false');
      if(item.indexOf(doc_colab) != -1 || item.indexOf(doc_manag) != -1) {
        var interval = setInterval(function(){
          check = $('iframe').contents().find('#checkcheckcheck').val();
          if(check == 'true') {
            clearInterval(interval);
            $('.action').find('.check').trigger('click');
          }
        },100)
      }
    }
    $(document).ready(function(){
      checkCheck();
    })
</script>
% endif
<style>
  body.view-in-course .course-wrapper{
    max-width: 1440px;
  }
</style>
<script>
 /*------------------------- DYNAMIC QUIZ--------------------------------------------*/
  // Display Answers on submit
$(document).ajaxSuccess(function(event, request, settings){
  if(settings.url.indexOf('problem_check')>=0 ) {
    // Adapt quiz status
    question_id="problem_"+settings.url.split('block@')[1].split('/');
    problem_title=$('#'+question_id).find('.problem-header');
    var data = JSON.parse(request.responseText);
    //problem check
    var url_show_pb=settings.url.replace('/problem_check','')+'/problem_show';
    if(data['success']=="incorrect"){
      if(problem_title.html().indexOf('<i')<0){
        problem_title.html(problem_title.html()+' <i style="color:red;" class="fa fa-times"></i>').addClass('failed_quiz');
        $('#'+question_id).addClass('failed_quiz').addClass('answered_tma');
      }
      if($('#'+question_id).find('.attempts_tma').attr('data-remainingattp')<=0){
        ajax_problem_show(url_show_pb, question_id);
      }
    }
    else{
      if(problem_title.html().indexOf('<i')<0){
        problem_title.html(problem_title.html()+' <i style="color:green;" class="fa fa-check"></i>').addClass('success_quiz');
        $('#'+question_id).addClass('success_quiz').addClass('answered_tma');
      }
      ajax_problem_show(url_show_pb, question_id);
      //$("#"+question_id).find('.action .check').hide();
    }
    //Update progress to get points
    $('#'+question_id).attr('data-progress_detail', data['progress_detail']);
    //Disable submit button
    $('#'+question_id).find('.action .check').addClass('is-disabled');
    //Add custom checkmark
    $("#"+question_id).find('label').each(function(){
      $(this).append('<span class="checkmark"><svg height="30" width="30"><circle cx="15" cy="15" r="14" shape-rendering="crispEdges" stroke="#eee" stroke-width="1" fill="#eee" /></svg></span>');
      $(this).append("<span class='checkfail hide'><img src='${static.url('images/failquestion.png')}' alt='fail_question'/></span>");
    })

  }
});

function ajax_problem_show(url_show_pb, question_id){
  $.ajax({
      url:url_show_pb,
      type:'POST',
      dataType:'json',
      success:function(data){
        //prepare answers
        answers=data['answers'];
         $.each(answers, function(key, value) {
           if ($.isArray(value)) {
             for (i = 0, len = value.length; i < len; i++) {
               $('#'+question_id).find('input[value='+value[i]+']').parent('label').addClass('choicegroup_correct');
             }
           }
           else{
             if(key.indexOf('solution')>0){
               $('#'+question_id).find('.problem').after(value);
             }
           }
         });
         //All other answers are false
         $('#'+question_id).find('label').each(function(){
           if(!$(this).hasClass('choicegroup_correct') && $(this).find('input').is(':checked')){
             $(this).addClass('choicegroup_incorrect');
           }
         })
         //Disable submit button
         $('#'+question_id).find('.action .check').addClass('is-disabled');
         //Display detailed solution if last attempt
         if($("#"+question_id).find('.attempts_tma').attr('data-remainingattp')<=0){
           $("#"+question_id).addClass('show-detailed');
         }
      }
    });
}

// in case of reset readd customized checkboxes
$(document).ajaxSuccess(function(event, request, settings){
  if(settings.url.indexOf('problem_reset')>=0 || settings.url.indexOf('problem_get')>=0 ) {
    problem_id=settings.url.split('block@')[1].split('/handler')[0]
    $('#problem_'+problem_id).find('label').each(function(){
      $(this).append('<span class="checkmark"><svg height="30" width="30"><circle cx="15" cy="15" r="14" stroke="#eee" shape-rendering="crispEdges" stroke-width="1" fill="#eee" /></svg></span>');
    })
    $('#problem_'+problem_id).find('.action .check').addClass('is-disabled');
    $('#problem_'+problem_id).removeClass('failed_quiz').removeClass('success_quiz');
  }
});

// Color highlight of questions choices
$('.checkmark').live('click', function(){
  $(this).parents('.problem').find('label').each(function(){
    $(this).removeClass('selected_tma');
  });
  $(this).parent('label').addClass('selected_tma');
})
$('label').live('click', function(){
  $(this).parents('.problem').find('label').each(function(){
    $(this).removeClass('selected_tma');
  });
  $(this).addClass('selected_tma');
})

//prepare question already answered
function prepare_questions(){
  i=0;
  $('.problems-wrapper').each(function(){
    indicator_container=$(this).find('.indicator-container span');
    wrong_choice=$(this).find('.choicegroup_incorrect');
    good_choice=$(this).find('.choicegroup_correct');
    problem_title=$(this).find('.problem-header');
    question_id=$(this).attr('id');
    url_show_pb=$(this).attr('data-url')+"/problem_show"
    if(indicator_container.hasClass('incorrect') || wrong_choice.length>0){
      $(this).addClass('failed_quiz').addClass('answered_tma');
      if(problem_title.html().indexOf('<i')<0){
        problem_title.html(problem_title.html()+' <i style="color:red;" class="fa fa-times"></i>');
      }
      $(this).find('.action .check').hide();
      //for failed quiz only show answers on last attempts
      if($(this).find('.attempts_tma').attr('data-remainingattp')<=0){
        ajax_problem_show(url_show_pb, question_id);
      }
    }
    else if(indicator_container.hasClass('correct')  || good_choice.length>0){
      $(this).addClass('success_quiz').addClass('answered_tma');
      //$("#"+question_id).find('.action .check').hide();
      if(problem_title.html().indexOf('<i')<0){
        problem_title.html(problem_title.html()+' <i style="color:green" class="fa fa-check"></i>');
      }
      //$(this).find('.action .check').hide();
      ajax_problem_show(url_show_pb, question_id);
    }
    // Customize radio btn and checkboxes
    $(this).find('label').each(function(){
      $(this).append('<span class="checkmark"><svg height="30" width="30"><circle cx="15" cy="15" r="14" stroke="#eee" shape-rendering="crispEdges" stroke-width="1" fill="#eee" /></svg></span>');
      $(this).append("<span class='checkfail hide'><img src='${static.url('images/failquestion.png')}' alt='fail_question'/></span>");
    })
  })
}
$(document).ready(function(){
  prepare_questions();
  // Hide bookmark on pages with QUIZ
  if($('.problems-wrapper').length>0){
    $('.bookmark-button-wrapper').hide();
    $('.course-content').css('padding-top','0px')
  }
  //Display of points and attempts
  $('.problem-progress').each(function(){
    $(this).html($(this).html().replace('(','').replace(')',' - '));
  });
  setInterval(function(){
    $('.problem-progress').each(function(){
      $(this).html($(this).html().replace('(','').replace(')',' - '));
    });
  }, 200);
});

// On checkbox click removeClass selected
$( ":checkbox" ).live('click', function(){
  $(this).parent('label').toggleClass('tma_choice_selected');
  if($(this).parent('label').hasClass('tma_choice_selected')){
    $(this).parent('label').removeClass('tma_basic_choice');
  }
  else{
    $(this).parent('label').addClass('tma_basic_choice');
    $(this).parent('label').removeClass('selected_tma');
  }
})

$( ":radio" ).live('click', function(){
  $(this).parents('fieldset').find('label').each(function(){
    $(this).removeClass('tma_choice_selected');
    $(this).addClass('tma_basic_choice');
  });
  $(this).parent('label').toggleClass('tma_choice_selected');
});



/////////////////////// USER GRADE FEEDBACK ///////////////////////////////////////////////
course_id = "${course.id | n, js_escaped_string}";
function display_success(score_obtenu, score_max, score_pourcent){
  var message_success="<div class='success_message_tma'><p class='tma_message_title'>Félicitations</p> <p>Vous avez obtenu score_obtenu / score_max bonne(s) réponse(s) soit score_pourcent%.</p></div>";
  message_success=message_success.replace('score_obtenu',score_obtenu).replace('score_max',score_max).replace('score_pourcent',score_pourcent);
    $('#tma_message').html(message_success);
}

function display_fail(score_pourcent, score_minimum){
  var message_fail="<div class='fail_message_tma'><p class='tma_message_title'>Aïe, votre score n'est pas suffisant!</p> <p>Vous avez obtenu score_pourcent% de bonnes réponses.</p> <p>Le minimum requis pour ce quiz est de score_minimum%.</p></div>";
  message_fail=message_fail.replace('score_minimum',score_minimum).replace('score_pourcent',score_pourcent);
  $('#tma_message').html(message_fail);
}

// Get user grade
function get_user_grade(score_total,score_student){
  $.ajax({
      url:"/final_grades/"+course_id+'/',
      type:'GET',
      dataType:'json',
      success:function(data){
        grade=data['Grade'];
        pass="${course.__dict__['_grading_policy']['GRADE_CUTOFFS']['Pass']}";
        if(grade>=pass){
          display_success(score_student, score_total, Math.round(grade*100));
        }
        else{
          display_fail(Math.round(grade*100), Math.round(pass*100));
        }
      }
    });
}

function display_results(){
  var all_answered=true;
  score_student=0;
  score_total=0;
  $('.problems-wrapper').each(function(){
    if(!$(this).hasClass('answered_tma')){
      all_answered=false;
    }
    else{
      //count points
      points=$(this).attr('data-progress_detail');
      score_total+= parseInt(points.split('/')[1]);
      score_student+= parseInt(points.split('/')[0]);
    }
  });
  if(all_answered){
    get_user_grade(score_total,score_student);
    return true;
  }
  else{
    return false;
  }
}
$('.action .reset').live('click', function(){
  $('#tma_message').html('');
  $(this).parents('.problems-wrapper').removeClass('answered_tma')
})

/*
$(document).ready(function(){
  display_results();
});

$(document).ajaxSuccess(function(event, request, settings){
  if(settings.url.indexOf('problem_check')>=0 ) {
    finished_test=display_results();
    if(finished_test){
      $("html, body").animate({ scrollTop: $('#tma_message').offset().top }, 1000);
    }
  }
});*/

</script>
<link rel="stylesheet" type="text/css" href="${static.url('css/courseware.css')}" />
<!--<link rel="stylesheet" href="/media/csswork/courseware.css">-->
<script src="${static.url('js/courseware.js')}"></script>

